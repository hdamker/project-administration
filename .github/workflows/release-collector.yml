# =========================================================================================
# CAMARA Project - Release Collector: Analysis & Staging
#
# Collects and reports release metadata across all CAMARA API repositories. Interim
# solution until Spring 2026 when native release-metadata.yaml files become standard.
#
# Key Features:
# - Incremental updates (detect and analyze only new releases)
# - Full re-analysis capability for workflow updates
# - Focus on public releases with API-name centric viewing
# - Enhanced HTML viewers with sorting, filtering, and statistics
#
# PREREQUISITES:
# - GITHUB_TOKEN (automatic) for API access
# - GitHub Pages enabled on this repository for staging deployment
#
# CHANGELOG:
# - 2024-12-17: Standardized header format, moved config to /config
#
# DOCUMENTATION:
# https://github.com/camaraproject/project-administration/blob/main/workflows/release-collector/docs/README.md
# =========================================================================================

name: Release Collector - Analysis & Staging

on:
  workflow_dispatch:
    inputs:
      analysis_scope:
        description: 'What to analyze'
        required: true
        type: choice
        options:
          - incremental    # Detect and analyze new releases only
          - full          # Re-analyze all releases
        default: incremental

      execution_mode:
        description: 'How to handle results'
        required: true
        type: choice
        options:
          - dry-run       # Test mode - no commits, artifacts only
          - pr            # Create pull request for review
        default: dry-run

      debug_mode:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false

      force_viewers:
        description: 'Force viewer regeneration even if no data updates'
        required: false
        type: boolean
        default: false

      force_metadata:
        description: 'Force metadata regeneration even if no data updates'
        required: false
        type: boolean
        default: false

  # schedule:
  #   # Daily run at 04:35 UTC (for testing)
  #   - cron: '35 4 * * *'

env:
  # Effective inputs (with defaults for scheduled runs)
  # Scheduled runs use: incremental analysis, pr mode, no debug, no force
  ANALYSIS_SCOPE: ${{ github.event.inputs.analysis_scope || 'incremental' }}
  EXECUTION_MODE: ${{ github.event.inputs.execution_mode || 'pr' }}
  DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
  FORCE_VIEWERS: ${{ github.event.inputs.force_viewers || 'false' }}
  FORCE_METADATA: ${{ github.event.inputs.force_metadata || 'false' }}

  # GitHub API Configuration
  GITHUB_ORG: 'camaraproject'
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Processing Configuration
  MAX_PARALLEL_JOBS: 6
  RELEASES_PER_PAGE: 100

  # Data Locations
  MASTER_METADATA_PATH: 'data/releases-master.yaml'
  CONFIG_PATH: 'config'
  REPORTS_PATH: 'reports'
  VIEWERS_PATH: 'viewers'

jobs:
  # =========================================================================================
  # Phase 1: Release Detection
  # Compare current releases with stored master metadata
  # =========================================================================================
  detect-releases:
    name: Detect New Releases
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.detect.outputs.has_updates }}
      has_new_releases: ${{ steps.detect.outputs.has_new_releases }}
      has_new_repos: ${{ steps.detect.outputs.has_new_repos }}
      templates_changed: ${{ steps.check_templates.outputs.templates_changed }}
      new_releases: ${{ steps.detect.outputs.new_releases }}
      all_repos: ${{ steps.detect.outputs.all_repos }}
      release_groups: ${{ steps.detect.outputs.release_groups }}
      warnings: ${{ steps.detect.outputs.warnings }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Check for template changes
        id: check_templates
        run: |
          # Check if template files changed in recent commits
          CHANGED=$(git diff HEAD~1 --name-only -- \
            'workflows/release-collector/templates/*.html' \
            'workflows/release-collector/templates/*.css' \
            'workflows/release-collector/templates/*.js' \
            2>/dev/null || echo "")

          if [ -n "$CHANGED" ]; then
            echo "templates_changed=true" >> $GITHUB_OUTPUT
            echo "âœ“ Template files changed:"
            echo "$CHANGED"
          else
            echo "templates_changed=false" >> $GITHUB_OUTPUT
            echo "âœ“ No template changes detected"
          fi

      - name: Install dependencies
        run: |
          npm install js-yaml axios @octokit/rest

      - name: Detect repositories and releases
        id: detect
        run: |
          echo "ðŸ” Detecting repositories and releases in analysis scope: ${{ env.ANALYSIS_SCOPE }}"

          # Create temp directory
          mkdir -p temp

          # Run detection script (also outputs repositories list)
          node workflows/release-collector/scripts/detect-releases.js --mode ${{ env.ANALYSIS_SCOPE }} > temp/detection-output.json

          # Parse output
          HAS_UPDATES=$(jq -r '.has_updates' temp/detection-output.json)
          HAS_NEW_RELEASES=$(jq -r '.has_new_releases' temp/detection-output.json)
          HAS_NEW_REPOS=$(jq -r '.has_new_repos' temp/detection-output.json)
          RELEASES_TO_ANALYZE=$(jq -c '.releases_to_analyze' temp/detection-output.json)
          RELEASES_COUNT=$(jq -r '.releases_count' temp/detection-output.json)
          REPOS_COUNT=$(jq -r '.repositories_count' temp/detection-output.json)

          echo "has_updates=${HAS_UPDATES}" >> $GITHUB_OUTPUT
          echo "has_new_releases=${HAS_NEW_RELEASES}" >> $GITHUB_OUTPUT
          echo "has_new_repos=${HAS_NEW_REPOS}" >> $GITHUB_OUTPUT
          echo "releases_to_analyze=${RELEASES_TO_ANALYZE}" >> $GITHUB_OUTPUT

          # Extract repositories list for update-master.js
          jq '{repositories: .repositories}' temp/detection-output.json > temp/repositories.json

          # Create release groups for parallel processing
          # Split into groups of 20 releases
          node -e "
            const releases = ${RELEASES_TO_ANALYZE};
            const groupSize = 20;
            const groups = [];
            for (let i = 0; i < releases.length; i += groupSize) {
              groups.push(releases.slice(i, i + groupSize));
            }
            console.log(JSON.stringify(groups));
          " > temp/release-groups.json

          echo "release_groups=$(cat temp/release-groups.json)" >> $GITHUB_OUTPUT

          # Extract warnings (archived repository mismatch etc.)
          WARNINGS=$(jq -c '.warnings // []' temp/detection-output.json)
          WARNINGS_COUNT=$(jq '.warnings | length' temp/detection-output.json)
          echo "warnings=${WARNINGS}" >> $GITHUB_OUTPUT

          if [ "$WARNINGS_COUNT" -gt 0 ]; then
            echo "âš ï¸ ${WARNINGS_COUNT} warning(s) detected"
            jq -r '.warnings[]' temp/detection-output.json | while read -r w; do
              echo "  - $w"
            done
          fi

          echo "Found ${RELEASES_COUNT} releases to analyze across ${REPOS_COUNT} repositories"

      - name: Upload repositories data
        uses: actions/upload-artifact@v6
        with:
          name: repositories-data
          path: temp/repositories.json

  # =========================================================================================
  # Phase 2: Release Analysis (Parallel)
  # Fetch and analyze releases, extract API specifications
  # =========================================================================================
  analyze-releases:
    name: Analyze Releases
    needs: detect-releases
    if: needs.detect-releases.outputs.has_new_releases == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        releases: ${{ fromJSON(needs.detect-releases.outputs.release_groups) }}
      max-parallel: 6

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install js-yaml axios @octokit/rest

      - name: Analyze release group
        run: |
          echo "ðŸ“Š Analyzing release group"

          # Create temp directory
          mkdir -p temp

          # Create output file for this group
          echo '[]' > temp/analysis-results.json

          # Process each release in the group
          RELEASES='${{ toJSON(matrix.releases) }}'
          echo "${RELEASES}" | jq -c '.[]' | while read -r release; do
            REPO=$(echo "${release}" | jq -r '.repository')
            TAG=$(echo "${release}" | jq -r '.release_tag')

            echo "Analyzing ${REPO} @ ${TAG}..."

            # Run analysis script
            node workflows/release-collector/scripts/analyze-release.js --github "${REPO}" "${TAG}" > temp/single-analysis.json

            # Append to results
            jq -s '.[0] + [.[1]]' temp/analysis-results.json temp/single-analysis.json > temp/analysis-updated.json
            mv temp/analysis-updated.json temp/analysis-results.json
          done

          echo "Analysis complete for group"

      - name: Prepare analysis results for upload
        run: cp temp/analysis-results.json temp/analysis-results-${{ strategy.job-index }}.json

      - name: Upload analysis results
        uses: actions/upload-artifact@v6
        with:
          name: analysis-group-${{ strategy.job-index }}
          path: temp/analysis-results-${{ strategy.job-index }}.json

  # =========================================================================================
  # Phase 3: Data Processing
  # Combine results, apply corrections, update master metadata
  # =========================================================================================
  update-metadata:
    name: Update Master Metadata
    needs: [detect-releases, analyze-releases]
    # Run if analyze-releases succeeded OR if new repos found (even without new releases)
    if: |
      always() &&
      (needs.analyze-releases.result == 'success' ||
       needs.detect-releases.outputs.has_new_repos == 'true')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install js-yaml axios

      - name: Download repositories data
        uses: actions/download-artifact@v7
        with:
          name: repositories-data
          path: temp/repositories-data

      - name: Download all analysis results
        if: needs.analyze-releases.result == 'success'
        uses: actions/download-artifact@v7
        with:
          pattern: analysis-group-*
          path: temp/analysis-downloads/
          merge-multiple: true

      - name: Combine and process data
        run: |
          echo "ðŸ”„ Processing release data..."

          # Ensure temp directory exists
          mkdir -p temp

          # Combine all analysis results
          echo '[]' > temp/combined-analysis.json
          for file in temp/analysis-downloads/analysis-results-*.json; do
            if [[ -f "$file" ]]; then
              jq -s '.[0] + .[1]' temp/combined-analysis.json "$file" > temp/combined-updated.json
              mv temp/combined-updated.json temp/combined-analysis.json
            fi
          done

          # Get repositories data (uploaded by detect-releases job)
          REPOS_FILE="temp/repositories-data/repositories.json"
          if [[ ! -f "$REPOS_FILE" ]]; then
            echo "ERROR: repositories.json not found"
            exit 1
          fi
          echo "Using $(jq '.repositories | length' $REPOS_FILE) repositories"

          # Update master metadata with release_type and repositories
          node workflows/release-collector/scripts/update-master.js \
            --mode ${{ env.ANALYSIS_SCOPE }} \
            --input temp/combined-analysis.json \
            --repos "$REPOS_FILE"

          echo "Master metadata updated with $(jq '. | length' temp/combined-analysis.json) releases"

      - name: Generate meta-release reports
        run: |
          echo "ðŸ“ Generating reports..."
          # Generate JSON files for each meta-release
          node workflows/release-collector/scripts/generate-reports.js

      - name: Upload processed data
        uses: actions/upload-artifact@v6
        with:
          name: processed-data
          path: |
            data/releases-master.yaml
            reports/*.json

  # =========================================================================================
  # Phase 3b: Generate Release Metadata Files
  # Create release-metadata.yaml/.json for GitHub release uploads
  # Always regenerates ALL files - diff shows what changed
  # =========================================================================================
  generate-release-metadata:
    name: Generate Release Metadata
    needs: [detect-releases, update-metadata]
    if: |
      always() &&
      (needs.update-metadata.result == 'success' ||
       (github.event.inputs.force_metadata || 'false') == 'true')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download processed data
        if: needs.update-metadata.result == 'success'
        uses: actions/download-artifact@v7
        with:
          name: processed-data

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install js-yaml

      - name: Generate release metadata files
        run: |
          echo "ðŸ“„ Generating release-metadata files for ALL releases..."

          node workflows/release-collector/scripts/generate-release-metadata.js

          # Show summary
          echo ""
          echo "Generated files:"
          find data/release-artifacts -name "*.yaml" -o -name "*.json" | head -20
          TOTAL=$(find data/release-artifacts -name "*.yaml" | wc -l | tr -d ' ')
          echo "Total releases with metadata: $TOTAL"

      - name: Upload release metadata artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-metadata-${{ github.run_number }}
          path: data/release-artifacts/
          retention-days: 30

  # =========================================================================================
  # Phase 4: Generate Viewers
  # Generate HTML viewers with embedded data
  # =========================================================================================
  generate-viewers:
    name: Generate HTML Viewers
    needs: [detect-releases, update-metadata]
    if: |
      always() &&
      (needs.update-metadata.result == 'success' ||
       needs.detect-releases.outputs.templates_changed == 'true' ||
       (github.event.inputs.force_viewers || 'false') == 'true')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download processed data
        if: needs.update-metadata.result == 'success'
        uses: actions/download-artifact@v7
        with:
          name: processed-data

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install js-yaml

      - name: Generate HTML viewers
        env:
          FORCE_REGENERATE: ${{ env.FORCE_VIEWERS }}
        run: |
          echo "ðŸŽ¨ Generating HTML viewers..."
          # Build viewers with embedded JSON
          node workflows/release-collector/scripts/generate-viewers.js

      - name: Upload final outputs as artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-reports-${{ github.run_number }}
          path: |
            data/releases-master.yaml
            reports/*.json
            viewers/*.html
          retention-days: 30

  # =========================================================================================
  # Phase 5: Commit/PR (only if not dry-run)
  # =========================================================================================
  publish-changes:
    name: Publish Changes
    needs: [detect-releases, generate-viewers, generate-release-metadata]
    if: |
      always() &&
      (github.event.inputs.execution_mode || 'pr') != 'dry-run' &&
      needs.generate-viewers.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      pr_url: ${{ steps.create-pr.outputs.pull-request-url }}
      pr_number: ${{ steps.create-pr.outputs.pull-request-number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download final artifacts
        uses: actions/download-artifact@v7
        with:
          name: release-reports-${{ github.run_number }}

      - name: Download release metadata (if generated)
        if: needs.generate-release-metadata.result == 'success'
        uses: actions/download-artifact@v7
        with:
          name: release-metadata-${{ github.run_number }}
          path: data/release-artifacts

      - name: Validate generated files
        if: env.EXECUTION_MODE == 'pr'
        run: |
          echo "Validating generated files..."

          # Check master YAML exists and is valid
          if [ ! -f data/releases-master.yaml ]; then
            echo "ERROR: Master YAML not found"
            exit 1
          fi

          # Validate YAML syntax
          python3 -c "import yaml; yaml.safe_load(open('data/releases-master.yaml'))"
          echo "âœ“ Master YAML is valid"

          # Check JSON reports exist and are valid
          for report in reports/*.json; do
            if [ -f "$report" ]; then
              jq empty "$report" || exit 1
              echo "âœ“ $(basename $report) is valid"
            fi
          done

          # Check HTML viewers exist
          for viewer in fall24 spring25 fall25 portfolio internal; do
            if [ ! -f "viewers/${viewer}.html" ]; then
              echo "WARNING: Viewer ${viewer}.html not found"
            else
              echo "âœ“ ${viewer}.html exists"
            fi
          done

          echo "All files validated successfully"

      - name: Check for changes
        id: diff
        if: env.EXECUTION_MODE == 'pr'
        run: |
          # Only commit data and reports (viewers are deployed separately in Phase 4)
          git add data/releases-master.yaml
          git add reports/*.json 2>/dev/null || true
          git add data/release-artifacts/ 2>/dev/null || true
          # Note: viewers/*.html are gitignored and deployed to camaraproject.github.io

          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git diff --cached --stat
            echo "change_summary<<EOF" >> $GITHUB_OUTPUT
            git diff --cached --stat >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: No changes summary
        if: env.EXECUTION_MODE == 'pr' && steps.diff.outputs.has_changes == 'false'
        run: |
          echo "## No Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The workflow completed successfully but no changes were detected." >> $GITHUB_STEP_SUMMARY
          echo "This typically means:" >> $GITHUB_STEP_SUMMARY
          echo "- No new releases since last run (incremental mode)" >> $GITHUB_STEP_SUMMARY
          echo "- Generated files are identical to existing data (full mode)" >> $GITHUB_STEP_SUMMARY

      - name: Get current timestamp
        id: timestamp
        run: echo "current=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      - name: Prepare warnings text
        id: warnings
        run: |
          WARNINGS='${{ needs.detect-releases.outputs.warnings }}'
          if [ "$WARNINGS" = "[]" ] || [ -z "$WARNINGS" ]; then
            echo "text=No warnings." >> $GITHUB_OUTPUT
          else
            {
              echo "text<<EOF"
              echo "âš ï¸ **Archived repository mismatch warnings:**"
              echo ""
              echo "$WARNINGS" | jq -r '.[] | "- " + .'
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi

      - name: Create pull request
        id: create-pr
        if: env.EXECUTION_MODE == 'pr' && steps.diff.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          branch: meta-release-update-${{ github.run_number }}
          title: 'Review: CAMARA release data updates from Release Collector bot'
          labels: automated
          body: |
            ## CAMARA Release Metadata Update

            **Analysis scope**: ${{ env.ANALYSIS_SCOPE }}
            **Workflow run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Generated**: ${{ steps.timestamp.outputs.current }}

            ### Changes

            This PR updates the CAMARA release tracking data:

            - ðŸ“Š `data/releases-master.yaml` - Master release metadata
            - ðŸ“ˆ `reports/*.json` - Meta-release reports (Fall24, Spring25, Fall25, All)
            - ðŸ“¦ `data/release-artifacts/` - Per-release metadata files (if generated)

            **Note**: Viewers are deployed to staging for preview. After merging, trigger the **Release Collector - Production Deploy** workflow to publish viewers and upload metadata to GitHub releases.

            ### File Changes

            ```
            ${{ steps.diff.outputs.change_summary }}
            ```

            ### Warnings

            ${{ steps.warnings.outputs.text }}

            ### Review Checklist

            - [ ] Master YAML contains expected releases
            - [ ] JSON reports are valid and complete
            - [ ] No sensitive data exposed
            - [ ] Data changes are accurate and complete

            ### Merge Instructions

            **Use squash and merge** to keep main history clean. Each workflow run creates a single logical change.

            ### After Merging

            1. **Trigger production deployment** - Run the "Release Collector - Production Deploy" workflow
               - Uses default mode (timestamp safety check ensures staging content matches main)
               - Deploys merged content to https://camaraproject.github.io/releases/

            ### Preview Viewers (Staging)

            Viewers have been deployed to GitHub Pages for preview:
            - [Fall24 Viewer](https://${{ github.repository_owner }}.github.io/project-administration/fall24.html)
            - [Spring25 Viewer](https://${{ github.repository_owner }}.github.io/project-administration/spring25.html)
            - [Fall25 Viewer](https://${{ github.repository_owner }}.github.io/project-administration/fall25.html)
            - [Portfolio Viewer](https://${{ github.repository_owner }}.github.io/project-administration/portfolio.html)
            - [Internal Admin View](https://${{ github.repository_owner }}.github.io/project-administration/internal.html)

            **Note**: Staging viewers are also available in workflow artifacts for download.

            ---

            *This PR was generated automatically by the Release Collector v3 workflow.*
          commit-message: |
            Review: CAMARA release data updates from Release Collector bot

            Analysis scope: ${{ env.ANALYSIS_SCOPE }}
            Workflow run: ${{ github.run_number }}

  # =========================================================================================
  # Phase 4: Deploy to GitHub Pages (Staging)
  # =========================================================================================
  deploy-staging:
    name: Deploy to Staging (GitHub Pages)
    needs: generate-viewers
    if: |
      always() &&
      (github.event.inputs.execution_mode || 'pr') == 'pr' &&
      needs.generate-viewers.result == 'success'
    permissions:
      contents: read
      pages: write
      id-token: write
    concurrency:
      group: "pages"
      cancel-in-progress: false
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download viewers
        uses: actions/download-artifact@v7
        with:
          name: release-reports-${{ github.run_number }}
          path: staging

      - name: Copy staging entry page
        run: |
          cp workflows/release-collector/staging-index.html staging/viewers/index.html
          echo "âœ“ Copied staging-index.html to viewers/index.html"

      - name: Show deployment contents
        run: |
          echo "About to publish:"
          ls -al staging/viewers

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: 'staging/viewers'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # =========================================================================================
  # Summary Job
  # =========================================================================================
  summary:
    name: Workflow Summary
    needs: [detect-releases, generate-viewers, publish-changes, deploy-staging]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate summary
        run: |
          echo "## Release Collector Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Analysis Scope**: ${{ env.ANALYSIS_SCOPE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution Mode**: ${{ env.EXECUTION_MODE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Updates Found**: ${{ needs.detect-releases.outputs.has_updates }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show warnings if any
          WARNINGS='${{ needs.detect-releases.outputs.warnings }}'
          if [ "$WARNINGS" != "[]" ] && [ -n "$WARNINGS" ]; then
            echo "### âš ï¸ Warnings" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$WARNINGS" | jq -r '.[] | "- " + .' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Determine state
          HAS_UPDATES="${{ needs.detect-releases.outputs.has_updates }}"
          FORCE_VIEWERS="${{ env.FORCE_VIEWERS }}"
          EXEC_MODE="${{ env.EXECUTION_MODE }}"
          PUBLISH_RESULT="${{ needs.publish-changes.result }}"
          STAGING_DEPLOYED="${{ needs.deploy-staging.result }}"
          PR_URL="${{ needs.publish-changes.outputs.pr_url }}"

          # Check if artifacts exist
          ARTIFACTS_EXIST="false"
          if [[ "$HAS_UPDATES" == "true" || "$FORCE_VIEWERS" == "true" ]]; then
            ARTIFACTS_EXIST="true"
          fi

          # Check if PR was created
          PR_CREATED="false"
          if [[ "$EXEC_MODE" == "pr" && "$PUBLISH_RESULT" == "success" && "$HAS_UPDATES" == "true" && -n "$PR_URL" ]]; then
            PR_CREATED="true"
          fi

          # Case 1: No changes detected
          if [[ "$ARTIFACTS_EXIST" == "false" ]]; then
            echo "### No Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo "- No new releases found in incremental analysis" >> $GITHUB_STEP_SUMMARY
            echo "- No artifacts generated" >> $GITHUB_STEP_SUMMARY
            echo "- All jobs skipped (no updates required)" >> $GITHUB_STEP_SUMMARY

          # Case 2: PR created
          elif [[ "$PR_CREATED" == "true" ]]; then
            echo "### Pull Request Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**PR**: [$PR_URL]($PR_URL)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A pull request has been created with updated release metadata." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Artifacts Available" >> $GITHUB_STEP_SUMMARY
            echo "- **release-reports-${{ github.run_number }}**: Contains all generated files" >> $GITHUB_STEP_SUMMARY
            echo "  - Master metadata (YAML)" >> $GITHUB_STEP_SUMMARY
            echo "  - JSON reports for each meta-release" >> $GITHUB_STEP_SUMMARY
            echo "  - HTML viewers with embedded data" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. **Review the PR** [$PR_URL]($PR_URL) - Check data changes and preview viewers" >> $GITHUB_STEP_SUMMARY
            echo "2. **Merge the PR** - Approve and merge to update master metadata" >> $GITHUB_STEP_SUMMARY
            echo "3. **Deploy to production** - Trigger production deployment workflow (manual)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Staging Preview" >> $GITHUB_STEP_SUMMARY
            echo "Viewers are deployed to:" >> $GITHUB_STEP_SUMMARY
            echo "- https://${{ github.repository_owner }}.github.io/project-administration/" >> $GITHUB_STEP_SUMMARY

          # Case 3: Viewers regenerated, no PR
          else
            echo "### Viewers Regenerated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Viewers have been regenerated but no PR was created (dry-run mode or forced regeneration)." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Artifacts Available" >> $GITHUB_STEP_SUMMARY
            echo "- **release-reports-${{ github.run_number }}**: Contains all generated files" >> $GITHUB_STEP_SUMMARY
            echo "  - Master metadata (YAML)" >> $GITHUB_STEP_SUMMARY
            echo "  - JSON reports for each meta-release" >> $GITHUB_STEP_SUMMARY
            echo "  - HTML viewers with embedded data" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. **Review viewers** - Download artifacts from workflow run page" >> $GITHUB_STEP_SUMMARY
            echo "2. **If changes look good** - Re-run workflow in PR mode for staging deployment and review" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Only show staging links if staging was actually deployed
            if [[ "$STAGING_DEPLOYED" == "success" ]]; then
              echo "### Staging Preview" >> $GITHUB_STEP_SUMMARY
              echo "Viewers are deployed to:" >> $GITHUB_STEP_SUMMARY
              echo "- https://${{ github.repository_owner }}.github.io/project-administration/" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Note**: Staging deployment only occurs in PR mode. Viewers are available in artifacts only." >> $GITHUB_STEP_SUMMARY
            fi
          fi