# Master Metadata Schema
# Schema for releases-master.yaml containing GitHub facts with format corrections only
# Version: 2.1.0
#
# Changes in 2.1.0:
# - Added optional repository_archived field to releases and repositories (issue #147)
#   Only present when true. Mirrors the superseded pattern for archived API repositories.
#
# Changes in 2.0.0:
# - Renamed 'version' to 'api_version' in APIs array (per issue #69 property alignment)
# - Renamed 'title' to 'api_title' in APIs array (per issue #69 property alignment)
#
# Changes in 1.1.0:
# - Added release_type field to releases (pre-release-alpha, pre-release-rc, public-release, maintenance-release)
# - Added repositories array with minimal release reference pointers (latest_public_release, newest_pre_release)
# - Extended version pattern to support pre-release extensions (-alpha.N, -rc.N)

$schema: http://json-schema.org/draft-07/schema#
title: CAMARA Master Metadata
description: Schema for master release metadata with format corrections applied
type: object
required:
  - metadata
  - releases

properties:
  metadata:
    type: object
    description: Metadata about the collection process
    required:
      - last_updated
      - last_checked
      - workflow_version
      - schema_version
    properties:
      last_updated:
        type: string
        format: date-time
        description: When data was last modified
      last_checked:
        type: string
        format: date-time
        description: When repositories were last scanned
      workflow_version:
        type: string
        pattern: "^\\d+\\.\\d+\\.\\d+$"
        description: Version of the workflow that generated this data
      schema_version:
        type: string
        pattern: "^\\d+\\.\\d+\\.\\d+$"
        description: Version of this schema

  releases:
    type: array
    description: List of all releases across all repositories
    items:
      type: object
      required:
        - repository
        - release_tag
        - release_date
        - meta_release
        - github_url
        - apis
      properties:
        repository:
          type: string
          pattern: "^[A-Za-z][A-Za-z0-9-]*$"
          description: GitHub repository name

        release_tag:
          type: string
          pattern: "^r\\d+\\.\\d+$"
          description: Release tag in rX.Y format

        release_date:
          type: string
          format: date-time
          description: ISO 8601 release timestamp

        meta_release:
          type: string
          description: Assigned meta-release cycle from configuration
          examples: ["Fall24", "Spring25", "Fall25", "Sandbox", "None"]

        github_url:
          type: string
          format: uri
          pattern: "^https://github\\.com/camaraproject/.*"
          description: Direct link to GitHub release

        release_type:
          type: string
          enum:
            - pre-release-alpha
            - pre-release-rc
            - public-release
            - maintenance-release
          description: |
            Classification of the release based on API versions and position in release cycle.
            - pre-release-alpha: GitHub prerelease with API versions containing -alpha extension
            - pre-release-rc: GitHub prerelease with API versions containing -rc extension
            - public-release: First non-prerelease in a release cycle (rX)
            - maintenance-release: Subsequent non-prereleases in the same cycle

        repository_archived:
          type: boolean
          description: |
            True when the source repository has been archived on GitHub.
            Only present when true (same pattern as 'superseded').
            Archived releases are included in all reports without filtering.

        apis:
          type: array
          description: API specifications in this release
          minItems: 1
          items:
            type: object
            required:
              - file_name
              - api_version
            properties:
              api_name:
                type: ["string", "null"]
                pattern: "^[a-z][a-z0-9-]*$"
                description: |
                  API name extracted from server URL (historical fact).
                  This is NOT corrected - preserved as found.

              file_name:
                type: string
                pattern: "^[a-zA-Z][a-zA-Z0-9-_]*$"
                description: Original YAML filename without extension

              api_version:
                type: string
                pattern: "^\\d+\\.\\d+\\.\\d+(-[a-z]+\\.\\d+)?$"
                description: |
                  Semantic version with format corrections applied.
                  'v' prefix is removed if present (v0.11.0 â†’ 0.11.0).
                  Pre-release extensions follow pattern: X.Y.Z-alpha.N or X.Y.Z-rc.N

              api_title:
                type: ["string", "null"]
                description: Human-readable API title from OpenAPI spec

              commonalities:
                type: ["string", "null"]
                pattern: "^\\d+\\.\\d+(?:\\.\\d+)?$"
                description: |
                  CAMARA Commonalities version as string.
                  Numbers are converted to strings, existing strings preserved as-is.

  repositories:
    type: array
    description: |
      All CAMARA API repositories with quick-reference release pointers.
      Minimal data focused on release tracking; comprehensive repository metadata is in a separate workflow.
    items:
      type: object
      required:
        - repository
        - github_url
      properties:
        repository:
          type: string
          pattern: "^[A-Za-z][A-Za-z0-9-]*$"
          description: GitHub repository name

        github_url:
          type: string
          format: uri
          pattern: "^https://github\\.com/camaraproject/.*"
          description: URL to the GitHub repository

        latest_public_release:
          type: ["string", "null"]
          pattern: "^r\\d+\\.\\d+$"
          description: |
            Tag of the most recent public-release or maintenance-release.
            Null if repository has no public releases yet.

        newest_pre_release:
          type: ["string", "null"]
          pattern: "^r\\d+\\.\\d+$"
          description: |
            Tag of the newest pre-release, only set if:
            - Newer than latest_public_release (same cycle rX.Y+1 or next cycle rX+1.Y), OR
            - latest_public_release is null (repo has only pre-releases)
            Null if no relevant pre-release exists.

        repository_archived:
          type: boolean
          description: |
            True when the repository has been archived on GitHub.
            Only present when true. Archived repos appear in the list
            but cannot accept PRs (campaigns must skip them).