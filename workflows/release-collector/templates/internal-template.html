<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CAMARA Release Administration (Alpha)</title>
  <style>
    {{VIEWER_STYLES}}

    /* CSS Variables */
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f6f8fa;
      --bg-tertiary: #ffffff;
      --text-primary: #24292f;
      --text-secondary: #57606a;
      --text-tertiary: #6e7681;
      --border-color: #d0d7de;
      --border-subtle: #eaeef2;
      --accent-color: #0969da;
      --accent-hover: #0550ae;
      --success-color: #1a7f37;
      --warning-color: #9a6700;
      --danger-color: #cf222e;
      --shadow-sm: 0 1px 0 rgba(27, 31, 36, 0.04);
      --shadow-md: 0 3px 6px rgba(140, 149, 159, 0.15);
      --shadow-lg: 0 8px 24px rgba(140, 149, 159, 0.2);
    }

    html[data-theme="dark"] {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #161b22;
      --text-primary: #c9d1d9;
      --text-secondary: #8b949e;
      --text-tertiary: #6e7681;
      --border-color: #30363d;
      --border-subtle: #21262d;
      --accent-color: #58a6ff;
      --accent-hover: #79c0ff;
      --success-color: #238636;
      --warning-color: #9e6a03;
      --danger-color: #da3633;
      --shadow-sm: 0 1px 0 rgba(240, 246, 252, 0.04);
      --shadow-md: 0 3px 6px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    /* Global styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-primary);
      background-color: var(--bg-primary);
      transition: background-color 0.2s, color 0.2s;
    }

    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 24px;
      margin-bottom: 24px;
      border-radius: 6px;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .header-subtitle {
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Admin control bar */
    .admin-controls {
      display: flex;
      gap: 16px;
      align-items: center;
      padding: 16px;
      margin-bottom: 24px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      flex-wrap: wrap;
    }

    .admin-controls label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-primary);
    }

    .admin-controls input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .admin-controls button {
      padding: 6px 16px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    .admin-controls button:hover {
      background: var(--bg-secondary);
    }

    /* Perspective toggle */
    .perspective-toggle {
      display: flex;
      gap: 8px;
    }

    .perspective-toggle button {
      padding: 6px 16px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s;
    }

    .perspective-toggle button.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    .perspective-toggle button:hover:not(.active) {
      background: var(--bg-secondary);
    }

    /* Filters */
    .filters {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 24px;
    }

    .filter-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .filter-row:last-child {
      margin-bottom: 0;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 200px;
    }

    .filter-group label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input[type="text"],
    select {
      padding: 6px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
    }

    input[type="text"]:focus,
    select:focus {
      outline: 2px solid var(--accent-color);
      outline-offset: 0;
    }

    /* Table */
    .table-container {
      background-color: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 24px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    thead {
      background-color: var(--bg-secondary);
      border-bottom: 2px solid var(--border-color);
    }

    th {
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg-secondary);
    }

    th:hover {
      background-color: var(--bg-primary);
    }

    tbody tr {
      border-bottom: 1px solid var(--border-subtle);
      transition: background-color 0.15s;
    }

    tbody tr:hover {
      background-color: var(--bg-secondary);
    }

    td {
      padding: 12px 16px;
      color: var(--text-primary);
    }

    /* Repository grouping */
    tr.repo-header {
      background-color: var(--bg-secondary);
      font-weight: 600;
      border-top: 2px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
    }

    tr.repo-header td {
      padding: 10px 16px;
      font-size: 15px;
      color: var(--text-primary);
    }

    tr.repo-row td:first-child {
      padding-left: 32px;
    }

    /* Special row types */
    .unpublished-row {
      background-color: rgba(212, 167, 44, 0.1);
    }

    .sandbox-row {
      background-color: rgba(251, 146, 60, 0.1);
    }

    /* Badges */
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid var(--border-color);
    }

    .badge-stable {
      background-color: #dafbe1;
      color: #0f5323;
      border-color: #0f5323;
    }

    .badge-initial {
      background-color: #fff4e5;
      color: #7d4e00;
      border-color: #7d4e00;
    }

    /* Debug button */
    .debug-btn {
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid var(--accent-color);
      background: var(--bg-tertiary);
      color: var(--accent-color);
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .debug-btn:hover {
      background: var(--accent-color);
      color: white;
    }

    /* Debug modal */
    .debug-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 24px;
      box-shadow: var(--shadow-lg);
      overflow-y: auto;
      z-index: 1000;
    }

    .debug-modal h3 {
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .debug-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    .debug-modal-close {
      float: right;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    .debug-modal-close:hover {
      background: var(--bg-secondary);
    }

    .debug-modal pre {
      background: var(--bg-secondary);
      padding: 16px;
      border-radius: 6px;
      overflow: auto;
      font-family: ui-monospace, 'Cascadia Code', 'Source Code Pro', Menlo, Consolas, monospace;
      font-size: 12px;
      line-height: 1.5;
      max-height: 60vh;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    /* View visibility */
    .hidden-view {
      display: none;
    }

    /* Status indicators */
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .status-published {
      background: var(--success-color);
    }

    .status-unpublished {
      background: var(--danger-color);
    }

    .status-sandbox {
      background: var(--warning-color);
    }

    /* Category pills */
    .category-pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
      padding: 8px 0;
    }

    .category-pill {
      padding: 6px 12px;
      border-radius: 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      color: var(--text-primary);
    }

    .category-pill:hover {
      background: var(--bg-tertiary);
      transform: translateY(-1px);
    }

    .category-pill.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    .category-count {
      margin-left: 4px;
      opacity: 0.7;
      font-size: 12px;
    }

    /* Links */
    a {
      color: var(--accent-color);
      text-decoration: none;
      font-weight: 500;
    }

    a:hover {
      text-decoration: underline;
    }

    /* Override shared styles for better readability */
    body,
    body:not(.in-iframe) {
      background: var(--bg-primary) !important;
      background-color: var(--bg-primary) !important;
      color: var(--text-primary) !important;
    }

    .container,
    body:not(.in-iframe) .container {
      background: var(--bg-primary) !important;
      background-color: var(--bg-primary) !important;
    }

    .header,
    body.in-iframe .header {
      background: var(--bg-secondary) !important;
      background-color: var(--bg-secondary) !important;
      background-image: none !important;
      border-color: var(--border-color) !important;
      display: block !important;
    }

    .header::before {
      display: none !important;
    }

    .header h1,
    h1 {
      color: var(--text-primary) !important;
    }

    .metadata,
    .header-subtitle {
      color: var(--text-secondary) !important;
    }

    .content,
    body.in-iframe .content {
      background: transparent !important;
      background-color: transparent !important;
    }

    .category-pills {
      background: var(--bg-secondary) !important;
      background-color: var(--bg-secondary) !important;
      background-image: none !important;
      border-color: var(--border-color) !important;
    }

    table {
      background: transparent !important;
      color: var(--text-primary) !important;
    }

    th {
      background: var(--bg-secondary) !important;
      color: var(--text-primary) !important;
      border-color: var(--border-color) !important;
    }

    td {
      border-color: var(--border-subtle) !important;
      color: var(--text-primary) !important;
    }

    .badge-stable {
      background-color: #dafbe1 !important;
      color: #0f5323 !important;
      border-color: #0f5323 !important;
    }

    .badge-initial {
      background-color: #fff4e5 !important;
      color: #7d4e00 !important;
      border-color: #7d4e00 !important;
    }
  </style>
</head>
</head>

<body class="internal-view">
  <div class="container">
    <div class="header">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <h1>CAMARA Release Administration (Alpha)</h1>
          <div class="header-subtitle" id="header-metadata">Internal View - All Data</div>
        </div>
        <div class="theme-toggle-wrapper">
          <button id="theme-toggle" class="theme-toggle-btn" aria-label="Toggle Dark Mode"
            style="background: rgba(0,0,0,0.1); border-color: rgba(0,0,0,0.1); color: var(--text-primary);">
            <span class="theme-icon">üåô</span>
          </button>
        </div>
      </div>
    </div>

    <div class="content" id="content">
      <!-- Admin Controls -->
      <div class="admin-controls">
        <div class="perspective-toggle">
          <button class="active" onclick="switchPerspective('api')">API-Centric</button>
          <button onclick="switchPerspective('repository')">Repository-Centric</button>
        </div>

        <button onclick="exportDebugData()">Export Debug Data</button>

        <label>
          <input type="checkbox" id="show-unpublished" checked onchange="applyFilters()">
          Show Unpublished
        </label>

        <label>
          <input type="checkbox" id="showOnlyLatestPatches" checked onchange="applyFilters()">
          Show only latest patch versions
        </label>
      </div>

      <!-- Category Pills -->
      <div class="category-pills" id="categoryPills">
        <div class="category-pill all-categories active" onclick="filterByCategory('')">
          All<span class="category-count" id="allCount">(0)</span>
        </div>
      </div>

      <!-- Filters -->
      <div class="filters">
        <div class="filter-row">
          <div class="filter-group">
            <label for="filterApiName">Search:</label>
            <input type="text" id="filterApiName" placeholder="API or repository..." onkeyup="applyFilters()">
          </div>
          <div class="filter-group">
            <label for="filterMaturity">Maturity:</label>
            <select id="filterMaturity" onchange="applyFilters()">
              <option value="">All</option>
              <option value="initial">Initial</option>
              <option value="stable">Stable</option>
              <option value="rc">RC</option>
              <option value="alpha">Alpha</option>
              <option value="beta">Beta</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterMetaRelease">Meta-Release:</label>
            <select id="filterMetaRelease" onchange="applyFilters()">
              <option value="">All</option>
              <option value="Fall24">Fall24</option>
              <option value="Spring25">Spring25</option>
              <option value="Fall25">Fall25</option>
              <option value="None (Sandbox)">Sandbox</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterPublished">Published:</label>
            <select id="filterPublished" onchange="applyFilters()">
              <option value="">All</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>
          <button class="clear-filters-btn" onclick="clearAllFilters()">Clear Filters</button>
        </div>
      </div>

      <!-- Results Counter -->
      <div id="resultsCounter" class="results-counter hidden">
        <div class="results-text"></div>
      </div>

      <!-- View 1: API-Centric -->
      <div id="view-api-centric" class="view-container">
        <table class="admin-table" id="apiTable">
          <thead>
            <tr>
              <th onclick="sortTable(0)">API <span class="sort-arrow"></span></th>
              <th onclick="sortTable(1)">Version <span class="sort-arrow"></span></th>
              <th onclick="sortTable(2)">Repository <span class="sort-arrow"></span></th>
              <th onclick="sortTable(3)">Release Tag <span class="sort-arrow"></span></th>
              <th onclick="sortTable(4)">Meta-Release <span class="sort-arrow"></span></th>
              <th onclick="sortTable(5)">Maturity <span class="sort-arrow"></span></th>
              <th onclick="sortTable(6)">Published <span class="sort-arrow"></span></th>
              <th onclick="sortTable(7)">Category <span class="sort-arrow"></span></th>
              <th onclick="sortTable(8)">First Release <span class="sort-arrow"></span></th>
              <th>Debug</th>
            </tr>
          </thead>
          <tbody id="apiTableBody">
          </tbody>
        </table>
      </div>

      <!-- View 2: Repository-Centric -->
      <div id="view-repository-centric" class="view-container hidden-view">
        <div id="repositoryContainer"></div>
      </div>

      <!-- Summary -->
      <div id="footer-metadata" class="footer-metadata"></div>
    </div>
  </div>

  <!-- Debug Modal (hidden by default) -->
  <div id="debug-modal-overlay" class="debug-modal-overlay hidden-view" onclick="closeDebugModal()"></div>
  <div id="debug-modal" class="debug-modal hidden-view">
    <button class="debug-modal-close" onclick="closeDebugModal()">Close</button>
    <h3>API Debug Information</h3>
    <pre id="debug-content"></pre>
  </div>

  <script>


    // Embedded shared library
    {{VIEWER_LIBRARY}}

    // Embedded release data (all data including unpublished)
    const RELEASE_DATA = {{RELEASE_DATA}};

    // Global state
    let currentData = null;
    let filteredData = [];
    let selectedCategories = [];
    let currentPerspective = 'api';
    let currentSort = { column: -1, ascending: true };
    let showOnlyLatestPatches = true; // Default: show only latest patches

    /**
     * Flatten v3 nested structure to flat array
     */
    function flattenAPIData(data) {
      const flatApis = [];

      if (data.releases && Array.isArray(data.releases)) {
        data.releases.forEach(release => {
          if (release.apis && Array.isArray(release.apis)) {
            release.apis.forEach(api => {
              flatApis.push({
                api_name: api.api_name,
                title: api.title || api.display_name || api.api_name,
                version: api.version,
                maturity: api.maturity,
                repository: release.repository,
                release_tag: release.release_tag,
                release_date: release.release_date,
                meta_release: release.meta_release,
                github_url: release.github_url,
                portfolio_category: api.portfolio_category,
                website_url: api.website_url,
                tooltip: api.tooltip,
                published: api.published,
                first_release: api.first_release,
                isNew: api.isNew,
                commonalities: api.commonalities,
                display_name: api.display_name,
                canonical_name: api.canonical_name
              });
            });
          }
        });
      }

      return flatApis;
    }

    /**
     * Group APIs by repository
     */
    function groupAPIsByRepository(apis) {
      const grouped = {};

      apis.forEach(api => {
        const key = api.repository;
        if (!grouped[key]) {
          grouped[key] = {
            repository: api.repository,
            apis: [],
            releases: []
          };
        }
        grouped[key].apis.push(api);
      });

      // Get unique releases per repo
      Object.keys(grouped).forEach(repo => {
        const releases = {};
        grouped[repo].apis.forEach(api => {
          const key = `${api.release_tag}|${api.meta_release}`;
          if (!releases[key]) {
            releases[key] = {
              tag: api.release_tag,
              meta_release: api.meta_release,
              date: api.release_date,
              github_url: api.github_url
            };
          }
        });
        grouped[repo].releases = Object.values(releases).sort((a, b) =>
          new Date(a.date) - new Date(b.date)
        );
      });

      return grouped;
    }

    /**
     * Initialize data
     */
    function initializeData() {
      const flatApis = flattenAPIData(RELEASE_DATA);

      currentData = {
        metadata: RELEASE_DATA.metadata,
        statistics: RELEASE_DATA.statistics,
        apis: flatApis
      };

      filteredData = currentData.apis;

      displayData(currentData);
    }

    /**
     * Display data
     */
    function displayData(data) {
      const metadata = data.metadata;
      const footerDiv = document.getElementById('footer-metadata');
      const generated = ViewerLib.formatDate(metadata.generated);

      const totalAPIs = data.apis.length;
      const publishedCount = data.apis.filter(a => a.published).length;
      const unpublishedCount = totalAPIs - publishedCount;
      const sandboxCount = data.apis.filter(a => a.meta_release === 'None (Sandbox)').length;

      footerDiv.innerHTML = `
        Report generated: ${generated} |
        Total API versions: ${totalAPIs} |
        Published: ${publishedCount} |
        Unpublished: ${unpublishedCount} |
        Sandbox: ${sandboxCount}
      `;

      buildCategoryPills();
      applyFilters();
    }

    /**
     * Build category pills
     */
    function buildCategoryPills() {
      const categoryCounts = ViewerLib.getCategoryCounts(currentData.apis);
      const pillsContainer = document.getElementById('categoryPills');

      const allCount = document.getElementById('allCount');
      allCount.textContent = `(${currentData.apis.length})`;

      const existingPills = pillsContainer.querySelectorAll('.category-pill:not(.all-categories)');
      existingPills.forEach(pill => pill.remove());

      const categoryOrder = [
        'Authentication and Fraud Prevention',
        'Communication Quality',
        'Communication Services',
        'Computing Services',
        'Device Information',
        'Location Services',
        'Payments and Charging',
        'Service Management'
      ];

      categoryOrder.forEach(category => {
        const count = categoryCounts[category];
        if (count) {
          const pill = document.createElement('div');
          pill.className = 'category-pill';
          pill.onclick = () => filterByCategory(category);
          pill.innerHTML = `${category}<span class="category-count">(${count})</span>`;
          pillsContainer.appendChild(pill);
        }
      });
    }

    /**
     * Filter by category (multi-select)
     */
    function filterByCategory(category) {
      if (category === '') {
        // "All" button - clear all selections
        selectedCategories = [];
      } else {
        // Toggle individual category
        const index = selectedCategories.indexOf(category);
        if (index > -1) {
          selectedCategories.splice(index, 1);
        } else {
          selectedCategories.push(category);
        }
      }

      updatePillStates();
      applyFilters();
    }

    /**
     * Update pill active states based on selectedCategories
     */
    function updatePillStates() {
      const pills = document.querySelectorAll('.category-pill');

      pills.forEach(pill => {
        pill.classList.remove('active');

        // "All" is active only when no categories selected
        if (pill.classList.contains('all-categories')) {
          if (selectedCategories.length === 0) {
            pill.classList.add('active');
          }
        } else {
          // Check if this pill's category is selected
          const pillText = pill.textContent.split('(')[0].trim();
          if (selectedCategories.includes(pillText)) {
            pill.classList.add('active');
          }
        }
      });
    }

    /**
     * Apply filters
     */
    function applyFilters() {
      if (!currentData) return;

      const searchFilter = document.getElementById('filterApiName').value.toLowerCase();
      const maturityFilter = document.getElementById('filterMaturity').value.toLowerCase();
      const metaReleaseFilter = document.getElementById('filterMetaRelease').value;
      const publishedFilter = document.getElementById('filterPublished').value;
      const showUnpublished = document.getElementById('show-unpublished').checked;
      showOnlyLatestPatches = document.getElementById('showOnlyLatestPatches').checked;

      filteredData = currentData.apis.filter(api => {
        // Category filter (multi-select with OR logic)
        if (selectedCategories.length > 0) {
          if (!selectedCategories.includes(api.portfolio_category)) {
            return false;
          }
        }

        // Search filter
        if (searchFilter &&
          !api.api_name.toLowerCase().includes(searchFilter) &&
          !api.title.toLowerCase().includes(searchFilter) &&
          !api.repository.toLowerCase().includes(searchFilter)) {
          return false;
        }

        // Maturity filter
        if (maturityFilter && api.maturity.toLowerCase() !== maturityFilter) {
          return false;
        }

        // Meta-release filter
        if (metaReleaseFilter && api.meta_release !== metaReleaseFilter) {
          return false;
        }

        // Published filter
        if (publishedFilter) {
          const isPublished = api.published;
          if (publishedFilter === 'yes' && !isPublished) return false;
          if (publishedFilter === 'no' && isPublished) return false;
        }

        // Show unpublished checkbox
        if (!showUnpublished && !api.published) {
          return false;
        }

        return true;
      });

      // Apply latest-patch filter if toggle is checked
      if (showOnlyLatestPatches) {
        filteredData = ViewerLib.filterLatestPatches(filteredData);
      }

      renderCurrentView();
    }

    /**
     * Clear all filters
     */
    function clearAllFilters() {
      document.getElementById('filterApiName').value = '';
      document.getElementById('filterMaturity').value = '';
      document.getElementById('filterMetaRelease').value = '';
      document.getElementById('filterPublished').value = '';
      document.getElementById('show-unpublished').checked = true;
      selectedCategories = [];
      updatePillStates();
      applyFilters();
    }

    /**
     * Switch perspective
     */
    function switchPerspective(perspective) {
      currentPerspective = perspective;

      // Update button states
      const buttons = document.querySelectorAll('.perspective-toggle button');
      buttons.forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // Hide all views
      document.querySelectorAll('.view-container').forEach(v => v.classList.add('hidden-view'));

      // Show selected view
      if (perspective === 'api') {
        document.getElementById('view-api-centric').classList.remove('hidden-view');
      } else {
        document.getElementById('view-repository-centric').classList.remove('hidden-view');
      }

      renderCurrentView();
    }

    /**
     * Render current view
     */
    function renderCurrentView() {
      if (currentPerspective === 'api') {
        renderAPICentricView();
      } else {
        renderRepositoryView();
      }

      updateResultsCounter();
    }

    /**
     * Render API-centric view
     */
    function renderAPICentricView() {
      const tbody = document.getElementById('apiTableBody');
      tbody.innerHTML = '';

      filteredData.forEach(api => {
        const row = document.createElement('tr');

        // Add row classes for visual indicators
        if (!api.published) {
          row.classList.add('unpublished-row');
        }
        if (api.meta_release === 'None (Sandbox)') {
          row.classList.add('sandbox-row');
        }

        // Status indicator
        const statusClass = !api.published ? 'status-unpublished' :
          api.meta_release === 'None (Sandbox)' ? 'status-sandbox' :
            'status-published';

        row.innerHTML = `
          <td><span class="status-indicator ${statusClass}"></span>${api.api_name}</td>
          <td>${api.version}</td>
          <td><a href="${api.github_url.replace(/\/releases\/tag\/.*$/, '')}" target="_blank">${api.repository}</a></td>
          <td><a href="${api.github_url}" target="_blank">${api.release_tag}</a></td>
          <td>${api.meta_release === 'None (Sandbox)' ? 'Sandbox' : api.meta_release}</td>
          <td>${ViewerLib.renderMaturityBadge(api.maturity)}</td>
          <td>${api.published ? '‚úì' : '‚úó'}</td>
          <td>${api.portfolio_category || '<em>Missing</em>'}</td>
          <td>${api.first_release || '-'}</td>
          <td><button class="debug-btn" onclick='showDebug(${JSON.stringify(api.api_name)}, ${JSON.stringify(api.version)}, ${JSON.stringify(api.release_tag)})'>üîç</button></td>
        `;

        tbody.appendChild(row);
      });

      if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #666;">No APIs match the current filters</td></tr>';
      }
    }

    /**
     * Render repository view
     */
    function renderRepositoryView() {
      const grouped = groupAPIsByRepository(filteredData);
      const container = document.getElementById('repositoryContainer');

      if (Object.keys(grouped).length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 48px; color: var(--text-secondary);">
            No repositories match the current filters
          </div>
        `;
        return;
      }

      // Build single unified table with repository grouping
      let tableHtml = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>API</th>
                <th>Version</th>
                <th>Release</th>
                <th>Meta-Release</th>
                <th>Maturity</th>
                <th>Published</th>
                <th>Category</th>
              </tr>
            </thead>
            <tbody>
      `;

      // Add rows grouped by repository
      Object.keys(grouped).sort().forEach(repoName => {
        const repo = grouped[repoName];
        const githubUrl = repo.apis[0].github_url.replace(/\/releases\/tag\/.*$/, '');

        // Repository header row
        tableHtml += `
          <tr class="repo-header">
            <td colspan="7">
              <a href="${githubUrl}" target="_blank" style="text-decoration: none; color: inherit;">
                ${repoName}
              </a>
              <span style="margin-left: 12px; font-weight: 400; font-size: 13px; color: var(--text-secondary);">
                ${repo.releases.length} releases ‚Ä¢ ${repo.apis.length} API versions
              </span>
            </td>
          </tr>
        `;

        // API rows for this repository
        repo.apis.forEach(api => {
          const rowClasses = [];
          if (!api.published) rowClasses.push('unpublished-row');
          if (api.meta_release === 'None (Sandbox)') rowClasses.push('sandbox-row');
          rowClasses.push('repo-row');

          tableHtml += `
            <tr class="${rowClasses.join(' ')}">
              <td>${api.api_name}</td>
              <td>${api.version}</td>
              <td><a href="${api.github_url}" target="_blank">${api.release_tag}</a></td>
              <td>${api.meta_release === 'None (Sandbox)' ? 'Sandbox' : api.meta_release}</td>
              <td>${ViewerLib.renderMaturityBadge(api.maturity)}</td>
              <td>${api.published ? '‚úì' : '‚úó'}</td>
              <td>${api.portfolio_category || '-'}</td>
            </tr>
          `;
        });
      });

      tableHtml += `
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = tableHtml;
    }

    /**
     * Show debug modal for specific API
     */
    function showDebug(apiName, version, releaseTag) {
      const api = filteredData.find(a =>
        a.api_name === apiName &&
        a.version === version &&
        a.release_tag === releaseTag
      );
      if (!api) return;

      const modal = document.getElementById('debug-modal');
      const overlay = document.getElementById('debug-modal-overlay');
      const content = document.getElementById('debug-content');

      content.textContent = JSON.stringify(api, null, 2);

      modal.classList.remove('hidden-view');
      overlay.classList.remove('hidden-view');
    }

    /**
     * Close debug modal
     */
    function closeDebugModal() {
      document.getElementById('debug-modal').classList.add('hidden-view');
      document.getElementById('debug-modal-overlay').classList.add('hidden-view');
    }

    /**
     * Export debug data
     */
    function exportDebugData() {
      const json = JSON.stringify(RELEASE_DATA, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `camara-internal-debug-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    /**
     * Sort table
     */
    function sortTable(columnIndex) {
      if (!filteredData || filteredData.length === 0) return;

      const table = document.getElementById('apiTable');
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));

      if (currentSort.column === columnIndex) {
        currentSort.ascending = !currentSort.ascending;
      } else {
        currentSort.column = columnIndex;
        currentSort.ascending = true;
      }

      rows.sort((a, b) => {
        let aValue = a.cells[columnIndex].textContent.trim();
        let bValue = b.cells[columnIndex].textContent.trim();

        if (aValue === '-') aValue = '';
        if (bValue === '-') bValue = '';

        let result = 0;

        if (columnIndex === 1) {
          // Version column
          result = ViewerLib.compareVersions(aValue, bValue);
        } else if (columnIndex === 6) {
          // Published column (‚úì/‚úó)
          result = (aValue === '‚úì' ? 1 : 0) - (bValue === '‚úì' ? 1 : 0);
        } else {
          result = aValue.localeCompare(bValue);
        }

        return currentSort.ascending ? result : -result;
      });

      rows.forEach(row => tbody.appendChild(row));
      updateSortIndicators(columnIndex);
    }

    /**
     * Update sort indicators
     */
    function updateSortIndicators(activeColumn) {
      const headers = document.querySelectorAll('#apiTable th');
      headers.forEach((header, index) => {
        const arrow = header.querySelector('.sort-arrow');
        if (!arrow) return;

        arrow.classList.remove('active-asc', 'active-desc');

        if (index === activeColumn) {
          if (currentSort.ascending) {
            arrow.classList.add('active-asc');
          } else {
            arrow.classList.add('active-desc');
          }
        }
      });
    }

    /**
     * Update results counter
     */
    function updateResultsCounter() {
      const counter = document.getElementById('resultsCounter');
      const resultsText = counter.querySelector('.results-text');

      const count = filteredData.length;

      if (count === 0) {
        resultsText.textContent = 'No APIs match the current filters';
        counter.classList.add('no-results');
      } else {
        // Count unique APIs in displayed data
        const uniqueCount = ViewerLib.countUniqueAPIs(filteredData);

        let message;
        if (uniqueCount === count) {
          // One entry per API
          message = `Showing ${uniqueCount} APIs`;
        } else {
          // Multiple entries for some APIs (different versions/releases)
          message = `Showing ${uniqueCount} APIs (${count} released versions)`;
        }

        resultsText.textContent = message;
        counter.classList.remove('no-results');
      }

      counter.classList.remove('hidden');
    }

    // Initialize on page load
    initializeData();
    // Initialize theme toggle (separate scope for internal viewer)
    ViewerLib.initThemeToggle('internal');
  </script>
</body>

</html>